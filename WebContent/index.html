<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>短点!</title>
<style type="text/css">
#progress p
{
	display: block;
	width: 240px;
	padding: 2px 5px;
	margin: 2px 0;
	border: 1px inset #446;
	border-radius: 5px;
}
#progress p.success
{
	background: #0c0 none 0 0 no-repeat;
}
#progress p.failed
{
	background: #c00 none 0 0 no-repeat;
}
#filedrag
{
	display: none;
	font-weight: bold;
	text-align: center;
	padding: 1em 0;
	margin: 1em 0;
	color: #555;
	border: 2px dashed #555;
	border-radius: 7px;
	cursor: default;
}
#filedrag.hover
{
	color: #f00;
	border-color: #f00;
	border-style: solid;
	box-shadow: inset 0 3px 4px #888;
}
</style>
<script type="text/javascript"
	src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.3.2.min.js"></script>
<script type="text/javascript">
	$(function() {
		$("#txt_button").click(function() {
			var data = $("#data").val();
			if (!data)
				return;
			$.ajax({
				type : 'POST',
				url : "api/create",
				data : {'data':data},
				cache : false,
				success : function(j) {
					if (j.ok) {
						alert("短地址: http://nutz.cn/" + j.code);
					} else {
						alert("ERROR : " + j.err);
					}
				},
				error : function () {
					alert("ERROR")
				},
				dataType : "json"
			});
		});
		
		function FileDragHover(e) {  
		    e.stopPropagation();  
		    e.preventDefault();  
		    e.target.className = (e.type == "dragover" ? "hover" : "");  
		}
		
		function FileSelectHandler(e) {  
		    // cancel event and hover styling  
		    FileDragHover(e);
		    var files = false;
		    if(e.originalEvent.dataTransfer){
		    	if(e.originalEvent.dataTransfer.files.length) {
		    		e.preventDefault();
		    		e.stopPropagation();
		    		files = e.originalEvent.dataTransfer.files
		    	}
		    }
		    if (! files)
		    	return;
		    
			var file = files[0];
			if (file.size == 0) {
				alert("Emtry File");
				return;
			}
			if (file.size > 1024*1024) {
				alert("Must less than 1mb")
				return;
			}
			var o = document.getElementById("progress");  
	        var progress = o.appendChild(document.createElement("p"));  
	        progress.appendChild(document.createTextNode("upload " + file.name));  
	        
			var xhr = new XMLHttpRequest();
			xhr.upload.addEventListener("progress", function(e) {  
			    var pc = parseInt(100 - (e.loaded / e.total * 100));  
			    progress.style.backgroundPosition = pc + "% 0";  
			}, false);
			xhr.onreadystatechange = function(e) {  
			    if (xhr.readyState == 4) {  
			        progress.className = (xhr.status == 200 ? "success" : "failure");
			        if (xhr.status == 200) {
			        	var j = eval("(" + xhr.responseText +")");
			        	if (j.ok) {
							alert("短地址: http://nutz.cn/" + j.code);
							return;
			        	}
			        }
			        alert("ERROR : " + j.err);
			        return;
			    }  
			};
			xhr.open("POST", "api/create/bin", true);
			xhr.setRequestHeader("X-File-Name", file.name);
			xhr.setRequestHeader("X-File-Size", file.size);
			xhr.send(file);
		}

		$("#filedrag").bind("dragover", FileDragHover);
		$("#filedrag").bind("dragleave",FileDragHover);
		$("#filedrag").bind("drop", FileSelectHandler);
	});
</script>
</head>
<body>
	<div>
		<textarea rows="10" cols="40" id="data"></textarea>
		<button id="txt_button">短点!</button>
	</div>
	<div id="progress"></div>
	<div>
		<div id="filedrag" style="display: block;">Drop files here</div>
	</div>
</body>
</html>